# ARP协议
## feature
ARP为IP地址到对应的硬件地址(MAC)之间提供动态映射  
32bit ip address -> 48bit ethernet address  
## ARP工作过程
1.dns将主机名转换成32位ip地址 gethostbyname()  
2.请求tcp与ip地址建立连接  
3.tcp发送一个连接请求分段到远端的主机，即向上述IP地址发送一份IP数据报  
4.如果目的主机在本地网络上（如以太网、令牌环网或点对点链接的另一端）,那么IP数据报可以直接送到目的主机上。如果目的主机在一个远程网络上，那么就通过IP选路函数来确定位于本地网络上的下一站路由器地址，并让它转发IP数据报。在这两种情况下，IP数据报都是被送到位于本地网络上的一台主机或路由器  
5.若目的主机在以太网，那么发送端主机必须把32 bit的IP地址变换成48 bit的以太网地址。从逻辑Internet地址到对应的物理硬件地址需要进行翻译。这就是ARP的功能  
6.ARP发送一份称作ARP请求的以太网数据帧给以太网上的每个主机。这个过程称作广播，ARP请求数据帧中包含目的主机的IP地址，其意思是“如果你是这个IP地址的拥有者，请回答你的硬件地址“  
7.目的主机的ARP层收到这份广播报文后，识别出这是发送端在寻问它的IP地址，于是发送一个ARP应答。这个ARP应答包含IP地址及对应的硬件地址  
8.收到ARP应答后，使用获取到ip地址和硬件地址就可以进行数据传输  
9.发送IP数据报到目的主机
## ARP协议背后的基本概念
网络接口有一个硬件地址（一个48 bit的值，标识不同的以太网或令牌环网络接口）。在硬件层次上进行的数据帧交换必须有正确的接口地址。但是，TCP/IP有自己的地址：32 bit的IP地址。知道主机的IP地址并不能让内核发送一帧数据给主机。内核（如以太网驱动程序）必须知道目的端的硬件地址才能发送数据。ARP的功能是在32 bit的IP地址和采用不同网络技术的硬件地址之间提供动态映射
## ARP高速缓存
ARP高效运行的关键是由于每个主机上都有一个ARP高速缓存。这个高速缓存存放了最近Internet地址到硬件地址之间的映射记录
*(192.168.136.1) at 5c:a4:8a:39:d3:c7 on en0 ifscope [ethernet]*
## ARP分组格式
![ARP分组格式](http://docs.52im.net/extend/docs/book/tcpip/vol1/4/images2/52im_3.png)  
当目的主机的硬件地址被发现后,通知请求端主机，然后发出第一段tcp报文  
请求端要发送IP数据报，那么数据报的接收端将很可能会发送一个ARP应答  
建立连接的TCP报文段序列时，会发现ARP请求对应于TCP试图发送的初始TCPSYN（同步）段,直到ARP回答返回时，TCP报文段才可以被发送，因为硬件地址到这时才可能知道  
## ARP代理
如果ARP请求是从一个网络的主机发往另一个网络上的主机，那么连接这两个网络的路由器就可以回答该请求，这个过程称作委托ARP或ARP代理(Proxy ARP)。这样可以欺骗发起ARP请求的发送端，使它误以为路由器就是目的主机，而事实上目的主机是在路由器的“另一边”。路由器的功能相当于目的主机的代理，把分组从其他主机转发给它
## 免费ARP
主机发送ARP查找自己的IP地址
免费ARP可以有两个方面的作用：
(1)一个主机可以通过它来确定另一个主机是否设置了相同的IP地址。主机并不希望对此请求有一个回答。但是，如果收到一个回答，那么就会在终端日志上产生一个错误消息“以太网地址：a:b:c:d:e:f发送来重复的IP地址”。这样就可以警告系统管理员，某个系统有不正确的设置  
(2)如果发送免费ARP的主机正好改变了硬件地址（很可能是主机关机了，并换了一块接口卡，然后重新启动），那么这个分组就可以使其他主机高速缓存中旧的硬件地址进行相应的更新。一个比较著名的ARP协议事实[Plummer 1982]是，如果主机收到某个IP地址的ARP请求，而且它已经在接收者的高速缓存中，那么就要用ARP请求中的发送端硬件地址（如以太网地址）对高速缓存中相应的内容进行更新。主机接收到任何ARP请求都要完成这个操作（ARP请求是在网上广播的，因此每次发送ARP请求时网络上的所有主机都要这样做）
