# IP:网际协议
## feature:
1.不可靠  
2.无连接  
## ip数据报格式
![ip数据报格式](http://docs.52im.net/extend/docs/book/tcpip/vol1/3/images2/52im_1.png)    
head（20byte）+ options(可变长) + data(at most 65515byte) = 65535byte+ 
网路字节序: 32bit二进制整数，0～7bit、8～15bit、16～23bit、24～31bit  
### 首部
TO S服务类型特性  
标识: 标识主机发送的每一份数据报  
TTL: 数据报可经过的最大网段数  
首部校验和  
源ip地址  
目的ip地址  
## IP路由选择
ip层即可以配置成路由器的功能，又可以配置成主机的功能  
ip层可以从传输层接收数据并进行发送  
ip层在内存中有一个路由表  
### IP路由原则
当数据来自某一网络接口时，IP首先检查目的IP地址是否为本机的IP地址之一或者IP广播地址。如果确实是这样，数据报就被送到由IP首部协议字段所指定的协议模块进行处理。如果数据报的目的不是这些地址，那么（1）如果IP层被设置为路由器的功能，那么就对数据报进行转发（也就是说，像下面对待发出的数据报一样处理）;否则（2）数据报被丢弃  
hop by hop
### route table config
目的地址  
下一跳  
flag  
### IP路由选择完成的功能
搜索路由表+子网掩码(判断源地址和目的地址是否在同一个网段)  
无法传输，提示主机不可达  
中间跳不可达、TTL返回ICMP报文  
为路由器指定路由表而不是为每台主机指定路由表,可以极大的减少路由表的规模  
本机路由表匹配失败,将数据报发送至default表目（gateway）  
### IP路由选择的关键点
主机和路由开启默认default路由  
数据报中的IP地址始终不发生变化  
链路层的首部地址始终都指向下一站的链路层地址  
## 子网寻址
经典B类地址子网划分=网络号（16bit） + 子网号（8bit） + 主机号（8bit）  
路由之间通过子网号进行转发
### 子网掩码
32bit 
1给网络号和子网号，0给主机号  
B类地址子网划分=网络号（16bit） + 子网号（8bit） + 主机号（8bit）  
11111111111111111111111100000000=0xffffff00=255.255.255.0  
B类地址子网划分=网络号（16bit） + 子网号（10bit） + 主机号（6bit）  
11111111111111111111111111000000=0xffffffc0=255.255.255.192    
子网掩码的界限非1byte时，通常使用16进制来表示，而非点分十进制
给定IP地址和子网掩码以后，主机就可以确定IP数据报的目的是：
(1)本子网上的主机  
(2)本网络中其他子网中的主机  
(3)其他网络上的主机。如果知道本机的IP地址，那么就知道它是否为A类、B类或C类地址(从IP地址的高位可以得知)，也就知道网络号和子网号之间的分界线。而根据子网掩码就可知道子网号与主机号之间的分界线  
## 特殊情况的IP地址
![特殊的IP地址](http://docs.52im.net/extend/docs/book/tcpip/vol1/3/images2/52im_9.png)    
特殊的源地址 0.x.x.x  
环回地址 127.x.x.x  
四类广播地址
## 动态选路
动态选路协议是用于动态选路的重要组成部分,但是他们只是使用在路由器之间,相邻路由器之间互相通信。系统(路有选择程序)选择比较合适的路有放到核心路由表中,然后系统就可以根据这个核心路有表找到最合适的网路。也就是说,动态选路是在系统 核心网络外部进行的,它只是用一些选路的策略影响路由表, 而不会影响到最后通过路由表选择路由的那一部分。
### 动态选路协议
RIP协议
## IP协议分片
基于MTU（max transport unit）分片  
IP在从上层接到数据以后,要根据IP地址来判断从那个接口发送数据(通过选路,不同的网络接口有不用的MTU),并进行MTU的查询,如果数据大小超过MTU就进行数据分片。数据的分片是对上层和下层透明,而数据也只是到达目的地还会被重新组装,不过不用担心,IP层提供了足够的信息进行数据的再组装  
在IP头里面,16bit识别号唯一记录了一个IP包的ID,具有同一个ID的IP片将会被重新组装;而13位片偏移则记录了某IP 片相对整个包的位置(解决数据报顺序问题);而这两个表示中间的3bit标志则标示着该分片后面是否还有新的分片。这三个标示就组成了IP分片的所有信息,接受方就可以利用这些信息对IP数据进行重新组织
