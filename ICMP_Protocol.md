# ICMP协议
ICMP经常被认为是IP层的一个组成部分(IP层之上)。它传递差错报文以及其他需要注意的信息。ICMP报文通常被IP层或更高层协议（TCP或UDP）使用。一些ICMP报文把差错报文返回给用户进程
## ICMP协议格式
![ICMP报文格式](http://docs.52im.net/extend/docs/book/tcpip/vol1/6/images2/52im_net_1.png)  
ICMP报文是在IP数据报内部被传输的  
## ICMP差错报文的类型
![ICMP报文类型](http://docs.52im.net/extend/docs/book/tcpip/vol1/6/images2/52im_net_3.png)  
下面各种情况都不会导致产生ICMP差错报文(避免广播风暴):  
(1)ICMP差错报文  
(2)目的地址是广播地址或多播地址的IP数据报。  
(3)作为链路层广播的数据报。  
(4)不是IP分片的第一片  
(5)源地址不是单个主机的数据报。这就是说，源地址不能为零地址、环回地址、广播地址或多播地址。  
## ICMP时间戳请求与应答
ICMP时间戳请求允许系统向另一个系统查询当前的时间。返回的建议值是自午夜开始计算的毫秒数，协调的统一时间（Coordinated Universal Time,UTC）
## ICMP端口不可达差错
## ICMP协议用途
ICMP 协议大致分为两类,一种是查询报文,一种是差错报文。其中查询报文有以下几种用途:  
(1)ping 查询(不要告诉我你不知道 ping 程序)  
(2)子网掩码查询(用于无盘工作站在初始化自身的时候初始化子网掩码)  
(3)时间戳查询(可以用来同步时间)  
而差错报文则产生在数据传送发生错误的时候
## ICMP应用
### ping
原理是用类型码为0的ICMP发请求,受到请求的主机则用类型码为8的ICMP回应。ping 程序来计算间隔时间,并计算有多少个包被送达。用户就可以判断网络大致的情况
### Traceroute
Traceroute是用来侦测主机到目的主机之间所经路由情况的重要工具,也是最便利的工具  
Traceroute 的原理是非常非常的有意思,它受到目的主机的 IP 后,首先给目的主机发送一个TTL=1的UDP数据包,而经过的第一个路由器收到这个数据包以后,就自动把 TTL减1,而TTL变为0以后,路由器就把这个包给抛弃了,并同时产生一个主机不可达的ICMP数据报给主机。主机收到这个数据报以后再发一个TTL=2的UDP数据报给目的主机,然后刺激第二个路由器给主机发ICMP数据报。如此往复直到到达目的主机。这样,traceroute就拿到了所有的路由器ip,从而避开了ip头只能记录有限路由IP的问题
## ICMP的IP重定向报文和路由发现报文
当 IP包在某一个地方转向的时候,都回给发送IP报的源主机一个ICMP重定向报文,而源主机就可以利用这个信息来更新自己的路由表,这样,随着网络通信的逐渐增多,路由表也就越来越完备,数据转发的速度也会越来越快。我们需要注意的是:  
(1)重定向报文只能由路由器发出。
(2)重定向报文为主机所用,而不是为路由器所用。
